<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoterTrace</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,sans-serif;background:#f8fafc;color:#0f172a;min-height:100vh;font-size:14px;line-height:1.5}

/* NAV */
.topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;padding:0 20px;height:52px;gap:12px}
.topbar-logo{font-weight:700;font-size:15px;color:#0f172a;margin-right:8px}
.tab-btn{padding:6px 14px;border-radius:6px;border:none;background:none;font-size:13px;font-weight:500;color:#64748b;cursor:pointer;transition:all .15s}
.tab-btn:hover{background:#f1f5f9;color:#0f172a}
.tab-btn.on{background:#eff6ff;color:#2563eb;font-weight:600}

/* LAYOUT */
.page{display:none;max-width:640px;margin:0 auto;padding:28px 20px 80px}
.page.on{display:block}

.page-title{font-size:20px;font-weight:700;margin-bottom:4px}
.page-sub{font-size:13px;color:#64748b;margin-bottom:24px}

/* CARD */
.box{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:20px;margin-bottom:14px}
.box-head{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#94a3b8;margin-bottom:14px}

/* UPLOAD â€” simple button approach, no invisible overlay tricks */
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:480px){.upload-grid{grid-template-columns:1fr}}

.upload-slot{}
.slot-label{font-size:11px;font-weight:600;letter-spacing:.4px;margin-bottom:6px;display:block}
.slot-label.f{color:#2563eb}
.slot-label.b{color:#7c3aed}

.upload-btn{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:6px;width:100%;padding:20px 12px;
  border:2px dashed #cbd5e1;border-radius:8px;
  background:#f8fafc;cursor:pointer;
  font-family:'Inter',sans-serif;font-size:12px;font-weight:500;color:#64748b;
  transition:all .15s;text-align:center;
}
.upload-btn:hover{border-color:#2563eb;background:#eff6ff;color:#2563eb}
.upload-btn.selected{border-color:#16a34a;border-style:solid;background:#f0fdf4;color:#15803d}
.upload-btn .ico{font-size:22px}

.thumb{width:100%;max-height:110px;object-fit:cover;border-radius:6px;border:1px solid #e2e8f0;margin-top:8px;display:none}

/* single upload (PDF) */
.upload-single{
  display:flex;flex-direction:column;align-items:center;justify-content:center;
  gap:8px;width:100%;padding:28px 16px;
  border:2px dashed #cbd5e1;border-radius:8px;
  background:#f8fafc;cursor:pointer;
  font-family:'Inter',sans-serif;font-size:13px;font-weight:500;color:#64748b;
  transition:all .15s;text-align:center;
}
.upload-single:hover{border-color:#2563eb;background:#eff6ff;color:#2563eb}
.upload-single.selected{border-color:#16a34a;border-style:solid;background:#f0fdf4;color:#15803d}
.upload-single .ico{font-size:28px}

/* BUTTON */
.btn{
  display:flex;align-items:center;justify-content:center;gap:7px;
  width:100%;padding:10px 18px;border-radius:8px;border:none;
  font-family:'Inter',sans-serif;font-size:13px;font-weight:600;
  cursor:pointer;transition:all .15s;margin-top:12px;
}
.btn-blue{background:#2563eb;color:#fff}
.btn-blue:hover{background:#1d4ed8}
.btn-blue:disabled{background:#bfdbfe;cursor:not-allowed}

/* PROGRESS */
.prog-wrap{margin-top:10px;display:none}
.prog-wrap.on{display:block}
.prog-track{height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden;margin-bottom:5px}
.prog-bar{height:100%;background:#2563eb;border-radius:2px;width:0;transition:width .3s}
.prog-txt{font-size:12px;color:#64748b}

/* SPINNER */
.spin{width:14px;height:14px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:rot .55s linear infinite;flex-shrink:0}
@keyframes rot{to{transform:rotate(360deg)}}

/* FIELDS */
.field-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:420px){.field-grid{grid-template-columns:1fr}}
.field-item{background:#f8fafc;border-radius:6px;padding:10px 12px}
.field-item.w2{grid-column:1/-1}
.field-k{font-size:10px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:2px}
.field-v{font-size:14px;font-weight:500;color:#0f172a}
.field-v.nil{font-size:12px;color:#cbd5e1;font-style:italic;font-weight:400}

/* SEARCH INPUTS */
.input-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
@media(max-width:460px){.input-row{grid-template-columns:1fr}}
.input-group label{display:block;font-size:12px;font-weight:600;color:#475569;margin-bottom:4px}
.input-group input{
  width:100%;padding:9px 12px;border:1px solid #e2e8f0;border-radius:7px;
  font-family:'Inter',sans-serif;font-size:13px;color:#0f172a;
  background:#fff;outline:none;transition:border-color .15s;
}
.input-group input:focus{border-color:#2563eb;box-shadow:0 0 0 3px #dbeafe}
.input-group input:disabled{background:#f8fafc;color:#cbd5e1;cursor:not-allowed}

/* RESULTS */
.result-item{
  background:#fff;border:1px solid #e2e8f0;border-radius:10px;
  padding:16px;margin-bottom:10px;
  transition:border-color .15s;
}
.result-item:hover{border-color:#bfdbfe}
.result-item.top{border-color:#2563eb}
.result-top-row{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;gap:10px}
.result-name{font-size:16px;font-weight:700;color:#0f172a}
.result-rel{font-size:12px;color:#64748b;margin-top:1px}
.badge{display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600}
.badge.hi{background:#dcfce7;color:#15803d}
.badge.mid{background:#fef9c3;color:#a16207}
.badge.lo{background:#fee2e2;color:#b91c1c}
.result-tags{display:flex;flex-wrap:wrap;gap:6px}
.tag{font-size:11px;padding:3px 9px;border-radius:5px;background:#f1f5f9;border:1px solid #e2e8f0;color:#475569}
.tag b{color:#0f172a}
.tag.hl{background:#eff6ff;border-color:#bfdbfe;color:#2563eb}
.tag.hl b{color:#1d4ed8}
.best-pin{
  position:absolute;top:-1px;right:12px;
  background:#2563eb;color:#fff;
  font-size:10px;font-weight:700;padding:2px 8px;
  border-radius:0 0 6px 6px;letter-spacing:.3px;
}
.result-item{position:relative}

/* EMPTY */
.empty{text-align:center;padding:36px 16px;color:#94a3b8}
.empty .e-ico{font-size:30px;margin-bottom:8px}
.empty p{font-size:13px}

/* RAW TEXT */
details{margin-top:12px}
details summary{font-size:12px;color:#94a3b8;cursor:pointer;user-select:none}
details pre{margin-top:8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:10px;font-size:10px;color:#64748b;white-space:pre-wrap;word-break:break-word;max-height:160px;overflow-y:auto;font-family:monospace}

/* BANNER */
.banner{padding:10px 14px;border-radius:7px;font-size:13px;margin-bottom:12px}
.banner.ok{background:#dcfce7;border:1px solid #bbf7d0;color:#15803d}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:#e2e8f0;border-radius:3px}
</style>
</head>
<body>

<div class="topbar">
  <span class="topbar-logo">VoterTrace</span>
  <button class="tab-btn on" id="t1" onclick="go('voter-id','t1')">Voter ID Reader</button>
  <button class="tab-btn"    id="t2" onclick="go('roll-search','t2')">Electoral Roll Search</button>
</div>

<!-- ====================================================
     PAGE 1: VOTER ID READER
===================================================== -->
<div class="page on" id="voter-id">
  <p class="page-title">Voter ID Reader</p>
  <p class="page-sub">Upload your voter ID card to extract name, EPIC number, and address details.</p>

  <div class="box">
    <div class="box-head">Upload Card</div>
    <div class="upload-grid">

      <!-- FRONT -->
      <div>
        <span class="slot-label f">â–² Front side</span>
        <button class="upload-btn" id="front-btn" onclick="document.getElementById('fi-front').click()">
          <span class="ico">ğŸªª</span>
          <span id="front-lbl">Click to choose image</span>
        </button>
        <input type="file" id="fi-front" accept="image/*" style="display:none">
        <img id="front-thumb" class="thumb" alt="">
      </div>

      <!-- BACK -->
      <div>
        <span class="slot-label b">â–¼ Back side</span>
        <button class="upload-btn" id="back-btn" onclick="document.getElementById('fi-back').click()">
          <span class="ico">ğŸ </span>
          <span id="back-lbl">Click to choose image</span>
        </button>
        <input type="file" id="fi-back" accept="image/*" style="display:none">
        <img id="back-thumb" class="thumb" alt="">
      </div>

    </div>

    <div class="prog-wrap" id="id-prog">
      <div class="prog-track"><div class="prog-bar" id="id-bar"></div></div>
      <div class="prog-txt" id="id-txt">Scanningâ€¦</div>
    </div>

    <button class="btn btn-blue" id="id-btn" disabled onclick="scanId()">
      Scan Voter ID
    </button>
  </div>

  <div id="id-out" style="display:none">
    <div class="box">
      <div class="box-head">Extracted Details</div>
      <div class="field-grid" id="id-fields"></div>
      <details>
        <summary>View raw scanned text</summary>
        <pre id="id-raw"></pre>
      </details>
    </div>
  </div>
</div>

<!-- ====================================================
     PAGE 2: ELECTORAL ROLL SEARCH
===================================================== -->
<div class="page" id="roll-search">
  <p class="page-title">Electoral Roll Search</p>
  <p class="page-sub">Upload the electoral roll PDF, then search by name to find voter details.</p>

  <!-- PDF Upload -->
  <div class="box">
    <div class="box-head">Step 1 â€” Upload Electoral Roll PDF</div>
    <button class="upload-single" id="pdf-btn" onclick="document.getElementById('fi-pdf').click()">
      <span class="ico">ğŸ“„</span>
      <span id="pdf-lbl">Click to choose PDF file</span>
    </button>
    <input type="file" id="fi-pdf" accept="application/pdf" style="display:none">

    <div class="prog-wrap" id="pdf-prog">
      <div class="prog-track"><div class="prog-bar" id="pdf-bar"></div></div>
      <div class="prog-txt" id="pdf-txt">Processingâ€¦</div>
    </div>

    <button class="btn btn-blue" id="pdf-btn-go" disabled onclick="scanPdf()">
      Process PDF
    </button>
  </div>

  <!-- Search â€” always visible, inputs disabled until PDF is processed -->
  <div class="box" id="search-box">
    <div class="box-head">Step 2 â€” Enter Name to Search</div>

    <div id="pdf-not-ready" style="display:flex;align-items:center;gap:8px;padding:10px 12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:7px;margin-bottom:14px;font-size:13px;color:#94a3b8">
      <span style="font-size:16px">â¬†ï¸</span>
      <span>Upload and process the PDF above first, then search here.</span>
    </div>

    <div id="pdf-ready-banner" style="display:none;padding:10px 12px;background:#f0fdf4;border:1px solid #bbf7d0;border-radius:7px;margin-bottom:14px;font-size:13px;color:#15803d;font-weight:500" id="pdf-ok-msg"></div>

    <div class="input-row">
      <div class="input-group">
        <label for="s-name">Voter Name</label>
        <input id="s-name" type="text" placeholder="e.g. Syed Abdul Naseer" disabled>
      </div>
      <div class="input-group">
        <label for="s-rel">Father / Husband Name</label>
        <input id="s-rel" type="text" placeholder="e.g. Abdul Basith" disabled>
      </div>
    </div>
    <button class="btn btn-blue" style="margin-top:0" id="search-btn" disabled onclick="doSearch()">Search</button>
  </div>

  <!-- Results -->
  <div id="roll-out" style="display:none">
    <div id="roll-cards"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/7.0.0/fuse.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

/* ============================================================
   GLOBAL STATE
============================================================ */
const G = { frontFile:null, backFile:null, pdfFile:null, entries:[] };

/* ============================================================
   NAV
============================================================ */
function go(pageId, tabId) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('on'));
  document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('on'));
  document.getElementById(pageId).classList.add('on');
  document.getElementById(tabId).classList.add('on');
}

/* ============================================================
   FILE INPUT WIRING
   Strategy: real buttons that call input.click()
   input.onchange reads the file â€” no invisible overlays
============================================================ */
function wireFileInput(inputId, btnId, lblId, thumbId, onFile) {
  const inp  = document.getElementById(inputId);
  const btn  = document.getElementById(btnId);
  const lbl  = document.getElementById(lblId);
  const thumb = thumbId ? document.getElementById(thumbId) : null;

  inp.addEventListener('change', function() {
    const file = this.files && this.files[0];
    if (!file) return;
    // Update button appearance
    btn.classList.add('selected');
    lbl.textContent = file.name.length > 28 ? file.name.slice(0,26)+'â€¦' : file.name;
    // Show thumbnail for images
    if (thumb && file.type.startsWith('image/')) {
      const fr = new FileReader();
      fr.onload = e => { thumb.src = e.target.result; thumb.style.display = 'block'; };
      fr.readAsDataURL(file);
    }
    onFile(file);
  });

  // Also allow drag-drop on the button itself
  btn.addEventListener('dragover', e => { e.preventDefault(); btn.style.borderColor = '#2563eb'; });
  btn.addEventListener('dragleave', () => { btn.style.borderColor = ''; });
  btn.addEventListener('drop', e => {
    e.preventDefault();
    btn.style.borderColor = '';
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;
    // Simulate as if user picked file via input
    const dt = new DataTransfer();
    dt.items.add(file);
    inp.files = dt.files;
    inp.dispatchEvent(new Event('change'));
  });
}

/* ============================================================
   TESSERACT
============================================================ */
let _T = null;
function getTess() {
  if (_T) return _T;
  _T = new Promise((res, rej) => {
    if (window.Tesseract) { res(window.Tesseract); return; }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js';
    s.onload = () => res(window.Tesseract);
    s.onerror = rej;
    document.head.appendChild(s);
  });
  return _T;
}

function setPb(barId, txtId, pct, msg) {
  const b = document.getElementById(barId);
  const t = document.getElementById(txtId);
  if (b) b.style.width = Math.min(100, pct) + '%';
  if (t && msg !== undefined) t.textContent = msg;
}

function clean(s) { return (s||'').replace(/\s+/g,' ').trim(); }

/* ============================================================
   VOTER ID â€” SCAN
============================================================ */
async function scanId() {
  if (!G.frontFile) { alert('Please choose a front image first.'); return; }
  const btn = document.getElementById('id-btn');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span>Scanningâ€¦';
  document.getElementById('id-prog').classList.add('on');

  try {
    const T = await getTess();

    // Pass 1: front, English
    setPb('id-bar','id-txt', 5, 'Reading front â€” Englishâ€¦');
    const w1 = await T.createWorker(['eng','hin'], 1, {
      logger: m => { if(m.status==='recognizing text') setPb('id-bar','id-txt', 5+m.progress*22, 'Reading front â€” Englishâ€¦'); }
    });
    const frontEng = (await w1.recognize(G.frontFile)).data.text;
    await w1.terminate();

    // Pass 2: front, Kannada
    setPb('id-bar','id-txt', 28, 'Reading front â€” Kannadaâ€¦');
    const w2 = await T.createWorker(['kan','eng'], 1, {
      logger: m => { if(m.status==='recognizing text') setPb('id-bar','id-txt', 28+m.progress*22, 'Reading front â€” Kannadaâ€¦'); }
    });
    const frontKan = (await w2.recognize(G.frontFile)).data.text;
    await w2.terminate();

    let backEng = '', backKan = '';
    if (G.backFile) {
      // Pass 3: back, English
      setPb('id-bar','id-txt', 52, 'Reading back â€” Englishâ€¦');
      const w3 = await T.createWorker(['eng','hin'], 1, {
        logger: m => { if(m.status==='recognizing text') setPb('id-bar','id-txt', 52+m.progress*18, 'Reading back â€” Englishâ€¦'); }
      });
      backEng = (await w3.recognize(G.backFile)).data.text;
      await w3.terminate();

      // Pass 4: back, Kannada
      setPb('id-bar','id-txt', 72, 'Reading back â€” Kannadaâ€¦');
      const w4 = await T.createWorker(['kan','eng'], 1, {
        logger: m => { if(m.status==='recognizing text') setPb('id-bar','id-txt', 72+m.progress*18, 'Reading back â€” Kannadaâ€¦'); }
      });
      backKan = (await w4.recognize(G.backFile)).data.text;
      await w4.terminate();
    }

    setPb('id-bar','id-txt', 96, 'Extracting detailsâ€¦');
    const fields = extractId(frontEng, frontKan, backEng, backKan);
    renderIdFields(fields, frontEng+'\n\n--- KANNADA ---\n\n'+frontKan+'\n\n--- BACK ---\n\n'+backEng+'\n\n'+backKan);
    setPb('id-bar','id-txt', 100, 'Done');

  } catch(e) {
    console.error(e);
    alert('Scan error: ' + e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Scan Voter ID';
  }
}

function extractId(fe, fk, be, bk) {
  be=be||''; bk=bk||''; fk=fk||'';
  const f={name:'',nameKan:'',rel:'',relKan:'',age:'',ageNote:'',sex:'',epic:'',addr:'',taluk:'',dist:'',part:'',serial:''};

  // â”€â”€ EPIC â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const em = (fe+be).match(/\b([A-Z]{3}[O0][0-9]{6,7})\b/i) || (fe+be).match(/IDENTITY\s+CARD\s+([A-Z0-9]{9,10})/i);
  if (em) f.epic = em[1].toUpperCase().replace(/O(?=[0-9])/g,'0');

  // â”€â”€ NAME (English) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const nm = fe.match(/elector'?s?\s*name\s*[:\-]\s*([A-Z][A-Za-z .'-]{2,45})/i)
           || fe.match(/voter'?s?\s*name\s*[:\-]\s*([A-Z][A-Za-z .'-]{2,45})/i)
           || fe.match(/\bname\s*[:\-]\s*([A-Z][A-Za-z .'-]{4,45})/i);
  if (nm) f.name = clean(nm[1]);

  // â”€â”€ NAME & RELATIVE (Kannada) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Strategy: find the two labelled lines using the Kannada label strings.
  // The card layout is always:
  //   à²®à²¤à²¦à²¾à²°à²° à²¹à³†à²¸à²°à³ : <full-Kannada-name>       â† elector name label
  //   à²¤à²‚à²¦à³†à²¯ à²¹à³†à²¸à²°à³ / à²ªà²¤à²¿ : <full-Kannada-rel>   â† father/husband label
  //
  // OCR often breaks a multi-word name across lines, so we collect all
  // Kannada-script words that follow a label until the next label or blank.

  function collectKannadaAfterLabel(text, labelPattern) {
    // Find label line, then grab the Kannada content on the same line and
    // any continuation lines that are purely Kannada script.
    const lines = text.split('\n').map(l => l.trim());
    for (let i = 0; i < lines.length; i++) {
      if (labelPattern.test(lines[i])) {
        // Extract content after the colon on the same line
        const inline = lines[i].replace(labelPattern, '').replace(/^[\s:â€“\-]+/, '').trim();
        const parts = inline ? [inline] : [];
        // Continue grabbing next lines that are purely Kannada (no English labels)
        for (let j = i+1; j < lines.length && j < i+4; j++) {
          const nx = lines[j];
          if (!nx) break;
          // Stop if next line starts a new English or Kannada label
          if (/elector|voter|father|husband|sex|age|name|s\/o|d\/o/i.test(nx)) break;
          if (/à²¤à²‚à²¦à³†|à²ªà²¤à²¿|à²®à²¤à²¦à²¾à²°|à²²à²¿à²‚à²—|à²µà²¯/.test(nx) && /[\u0C80-\u0CFF]{3,}/.test(nx) && /:/.test(nx)) break;
          if (/[\u0C80-\u0CFF]{2,}/.test(nx)) parts.push(nx);
          else break;
        }
        const result = parts.join(' ').trim();
        if (result.length > 2) return result;
      }
    }
    return '';
  }

  // Try labelled extraction first (most accurate)
  f.nameKan = collectKannadaAfterLabel(fk, /à²®à²¤à²¦à²¾à²°à²°\s*à²¹à³†à²¸à²°à³/);
  f.relKan  = collectKannadaAfterLabel(fk, /à²¤à²‚à²¦à³†à²¯\s*à²¹à³†à²¸à²°à³|à²¤à²‚à²¦à³†\s*[:\-]|à²ªà²¤à²¿\s*[:\-]/);

  // Fallback: if labels not found, use positional heuristic
  // Voter ID card structure in Kannada pass:
  //   Line N   = elector name (Kannada)
  //   Line N+1 = elector name continuation OR relative name
  //   Line N+2 = relative name
  // We know English name & relative, so we use word count to separate them.
  if (!f.nameKan || !f.relKan) {
    const kanLines = fk.split('\n').map(l => l.trim()).filter(l =>
      /[\u0C80-\u0CFF]{3,}/.test(l) &&
      l.length > 4 && l.length < 70 &&
      !/à²­à²¾à²°à²¤|à²šà³à²¨à²¾|à²—à³à²°à³à²¤à²¿à²¨|à²†à²¯à³‹à²—|à²­à²¾à²°à²¤/.test(l)
    );

    // The English name has N words â†’ the Kannada name should also have ~N words
    const engNameWords = f.name ? f.name.trim().split(/\s+/).length : 3;
    const engRelWords  = f.rel  ? f.rel.trim().split(/\s+/).length  : 2;

    let accumulated = [];
    let phase = 'name'; // collecting name, then rel

    for (const ln of kanLines) {
      const words = ln.trim().split(/\s+/).filter(w => /[\u0C80-\u0CFF]/.test(w));
      accumulated.push(...words);

      if (phase === 'name' && !f.nameKan) {
        if (accumulated.length >= engNameWords) {
          f.nameKan = accumulated.slice(0, engNameWords).join(' ');
          accumulated = accumulated.slice(engNameWords);
          phase = 'rel';
          if (accumulated.length >= engRelWords) {
            f.relKan = accumulated.slice(0, engRelWords).join(' ');
            break;
          }
        }
      } else if (phase === 'rel' && !f.relKan) {
        if (accumulated.length >= engRelWords) {
          f.relKan = accumulated.slice(0, engRelWords).join(' ');
          break;
        }
      }
    }
  }

  // â”€â”€ RELATIVE NAME (English) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const rm = fe.match(/father'?s?\s*name\s*[:\-]\s*([A-Z][A-Za-z .'-]{2,45})/i)
           || fe.match(/husband'?s?\s*name\s*[:\-]\s*([A-Z][A-Za-z .'-]{2,45})/i)
           || fe.match(/(?:S\/O|D\/O|W\/O)\s*[:\-.]?\s*([A-Z][A-Za-z .'-]{2,45})/i);
  if (rm) f.rel = clean(rm[1]);

  // â”€â”€ AGE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  // Primary: "Age as on D.M.YYYY : N" â†’ calculate current age
  // The boxed number N was age on reference date YYYY, so:
  //   currentAge â‰ˆ N + (currentYear - referenceYear)
  const ageAsOnM = (fe+' '+fk).match(/age\s+as\s+on\s+[\d.]*(\d{4})\s*[:\-]\s*(\d{1,3})/i)
                || (fe+' '+fk).match(/age\s+as\s+on\s+\d{1,2}[./]\d{1,2}[./](\d{4})\s*[:\-]?\s*(\d{1,3})/i);
  if (ageAsOnM) {
    const refYear = parseInt(ageAsOnM[1]);
    const ageAtRef = parseInt(ageAsOnM[2]);
    if (refYear > 1950 && refYear < 2030 && ageAtRef > 0 && ageAtRef < 120) {
      const currentYear = new Date().getFullYear();
      const approxAge = ageAtRef + (currentYear - refYear);
      f.age = String(approxAge);
      f.ageNote = `(was ${ageAtRef} as on 1.1.${refYear})`;
    }
  }

  // Fallback: plain "Age: N"
  if (!f.age) {
    const ag = (fe+' '+fk).match(/\bage\s*[:\-]\s*(\d{1,3})\b/i)
             || (fe+' '+fk).match(/\bage[a-z]*\s+(\d{1,3})\b/i);
    if (ag) { const n=parseInt(ag[1]); if(n>0&&n<120) f.age=String(n); }
  }

  // â”€â”€ SEX â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  const sx = (fe+' '+fk).match(/\bsex\s*[:\-]?\s*(male|female|m|f)\b/i);
  if (sx) { const s=sx[1].toLowerCase(); f.sex=(s==='m'||s==='male')?'Male':'Female'; }

  // â”€â”€ ADDRESS (from back side only) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
  if (be) {
    const am = be.match(/address\s*[:\-]\s*([^\n]{5,80})/i);
    if (am) f.addr = clean(am[1]);
    const tm = be.match(/taluk\s*[:\-]\s*([A-Za-z ()\-]{3,50})/i);
    if (tm) f.taluk = clean(tm[1]);
    const dm = be.match(/district\s*[:\-]\s*([A-Za-z ]{3,40})/i);
    if (dm) f.dist = clean(dm[1]);
    const pts = [];
    if (f.addr) pts.push(f.addr);
    if (f.taluk) pts.push(f.taluk + ' Taluk');
    if (f.dist)  pts.push(f.dist + ' District');
    if (pts.length) f.addr = pts.join(', ');

    // Serial/Part ONLY from back side "238 / 882" style
    // Use strict pattern: must be at end of back page, not inline with address
    const slm = be.match(/\b(\d{1,3})\s*\/\s*(\d{1,4})\s*$/m);
    if (slm) { f.serial = slm[1]; f.part = slm[2]; }
  }
  // If no back uploaded â†’ no part/serial (front-only card never shows these)

  return f;
}


function renderIdFields(f, raw) {
  // Age display: show calculated age + reference note if available
  const ageDisplay = f.age ? (f.ageNote ? `${f.age} ${f.ageNote}` : f.age) : '';

  const rows = [
    {k:'Name (English)',     v:f.name,       w:false},
    {k:'Name (Kannada)',     v:f.nameKan,    w:false, h:!f.nameKan},
    {k:'Father / Husband',  v:f.rel,        w:false},
    {k:'Relative (Kannada)',v:f.relKan,     w:false, h:!f.relKan},
    {k:'Age',               v:ageDisplay,   w:false},
    {k:'Sex',               v:f.sex,        w:false},
    {k:'EPIC No.',          v:f.epic,       w:false},
    {k:'Address',           v:f.addr,       w:true,  h:!f.addr},
    // Only show Part/Serial if actually found (back side uploaded + data present)
    {k:'Part No.',          v:f.part,       w:false, h:!f.part},
    {k:'Serial No.',        v:f.serial,     w:false, h:!f.serial},
  ].filter(r=>!r.h);

  document.getElementById('id-fields').innerHTML = rows.map(r=>`
    <div class="field-item${r.w?' w2':''}">
      <div class="field-k">${r.k}</div>
      <div class="field-v${r.v?'':' nil'}">${r.v||'Not found'}</div>
    </div>`).join('');
  document.getElementById('id-raw').textContent = raw;
  document.getElementById('id-out').style.display = 'block';
  document.getElementById('id-out').scrollIntoView({behavior:'smooth',block:'start'});
}


/* ============================================================
   PDF â€” SCAN
============================================================ */
async function scanPdf() {
  if (!G.pdfFile) { alert('Please choose a PDF file first.'); return; }
  const btn = document.getElementById('pdf-btn-go');
  btn.disabled = true;
  btn.innerHTML = '<span class="spin"></span>Processingâ€¦';
  document.getElementById('pdf-prog').classList.add('on');
  G.entries = [];

  try {
    const T = await getTess();
    const buf = await G.pdfFile.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const total = pdf.numPages;
    setPb('pdf-bar','pdf-txt', 4, `Found ${total} pages â€” scanningâ€¦`);

    // 2 parallel workers
    const allPgs = Array.from({length:total},(_,i)=>i+1);
    const mid = Math.ceil(total/2);
    const chunks = [allPgs.slice(0,mid), allPgs.slice(mid)].filter(c=>c.length);
    const workers = await Promise.all(chunks.map(()=>T.createWorker(['kan','eng'],1)));

    let done = 0;
    async function doChunk(w, pages) {
      const out = [];
      for (const pn of pages) {
        const pg = await pdf.getPage(pn);
        const vp = pg.getViewport({scale:1.6});
        const cv = document.createElement('canvas');
        cv.width=vp.width; cv.height=vp.height;
        await pg.render({canvasContext:cv.getContext('2d'),viewport:vp}).promise;
        const {data:{text}} = await w.recognize(cv);
        out.push(...parsePage(text,pn));
        done++;
        setPb('pdf-bar','pdf-txt', 6+Math.round(done/total*90), `Scanned ${done} of ${total} pagesâ€¦`);
      }
      return out;
    }

    const res = await Promise.all(workers.map((w,i)=>doChunk(w,chunks[i])));
    await Promise.all(workers.map(w=>w.terminate()));

    G.entries = res.flat().sort((a,b)=>(a.pageNum-b.pageNum)||((+a.serial||0)-(+b.serial||0)));
    setPb('pdf-bar','pdf-txt',100,`Done â€” ${G.entries.length} voter entries found`);

    // Enable search inputs
    const entryCount = G.entries.length;
    document.getElementById('pdf-not-ready').style.display = 'none';
    const readyBanner = document.getElementById('pdf-ready-banner');
    readyBanner.textContent = 'âœ“ ' + entryCount + ' voter entries loaded. Enter a name below and click Search.';
    readyBanner.style.display = 'block';
    document.getElementById('s-name').disabled = false;
    document.getElementById('s-rel').disabled = false;
    document.getElementById('search-btn').disabled = false;
    document.getElementById('search-box').scrollIntoView({behavior:'smooth',block:'start'});

  } catch(e) {
    console.error(e);
    alert('PDF error: '+e.message);
  } finally {
    btn.disabled = false;
    btn.innerHTML = 'Process PDF';
  }
}

function parsePage(text, pageNum) {
  const entries = [];
  const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
  let part = '';
  for (const ln of lines.slice(0,14)) {
    const pm = ln.match(/(?:part|à²­à²¾à²—)\s*[:\-#]?\s*(\d+)/i);
    if (pm) { part=pm[1]; break; }
  }

  let i=0;
  while (i<lines.length) {
    const m = lines[i].match(/^(\d{1,4})[.)]\s*(.+)$/);
    if (m) {
      const serial=m[1];
      const block=[clean(m[2])];
      let j=i+1;
      while (j<lines.length && j<i+8 && !/^\d{1,4}[.)]/.test(lines[j])) {
        block.push(clean(lines[j])); j++;
      }
      entries.push(buildEntry(block,serial,part,pageNum));
      i=j;
    } else { i++; }
  }

  if (!entries.length) {
    for (let k=0;k<lines.length;k++) {
      const am=lines[k].match(/(?:age|à²µà²¯)[:\s]*(\d{2,3})/i);
      if (am && parseInt(am[1])>0 && parseInt(am[1])<120) {
        entries.push({
          serial:String(entries.length+1), partNo:part, pageNum,
          name:clean(lines[Math.max(0,k-2)]||''),
          nameKan:'',
          relativeName:clean(lines[Math.max(0,k-1)]||''),
          relativeNameKan:'',
          age:am[1], sex:'', address:''
        });
      }
    }
  }
  return entries;
}

function buildEntry(block, serial, part, pageNum) {
  const e={serial, partNo:part, pageNum, name:'', nameKan:'', relativeName:'', relativeNameKan:'', age:'', sex:'', address:''};
  if (block[0]) {
    if (/[\u0C80-\u0CFF]{3,}/.test(block[0])) e.nameKan=block[0];
    else e.name=block[0];
  }
  for (let k=1;k<block.length;k++) {
    const ln=block[k];
    const agem=ln.match(/(?:age|à²µà²¯)[:\s]*(\d{1,3})/i);
    const sexm=ln.match(/(?:sex)[:\s]*(male|female|m|f)/i);
    const relm=ln.match(/(?:s\/o|d\/o|w\/o|father|husband|à²¤à²‚à²¦à³†|à²ªà²¤à²¿)[:\s]*(.+)/i);
    if (agem){const n=parseInt(agem[1]);if(n>0&&n<120){e.age=String(n);continue;}}
    if (sexm){e.sex=sexm[1];continue;}
    if (relm){const v=clean(relm[1]);if(/[\u0C80-\u0CFF]{3,}/.test(v))e.relativeNameKan=v;else e.relativeName=v;continue;}
    if (k===1&&!agem&&!sexm&&!relm){
      if(/[\u0C80-\u0CFF]{3,}/.test(ln)){if(e.nameKan&&!e.relativeNameKan)e.relativeNameKan=ln;else if(!e.nameKan)e.nameKan=ln;}
      else{if(e.name&&!e.relativeName)e.relativeName=ln;else if(!e.name)e.name=ln;}
      continue;
    }
    if (ln.length>2) e.address=(e.address?e.address+', ':'')+ln;
  }
  return e;
}

/* ============================================================
   SEARCH
============================================================ */
function doSearch() {
  const name = document.getElementById('s-name').value.trim();
  const rel  = document.getElementById('s-rel').value.trim();
  if (!name && !rel) { alert('Enter at least a voter name to search.'); return; }
  if (!G.entries.length) { alert('Please upload and process a PDF first (Step 1 above).'); return; }

  const fuse = new Fuse(G.entries, {
    includeScore:true, threshold:0.55, ignoreLocation:true,
    keys:[
      {name:'name',weight:.40}, {name:'nameKan',weight:.20},
      {name:'relativeName',weight:.28}, {name:'relativeNameKan',weight:.12}
    ]
  });

  let results = [];
  const seen = new Set();

  function addAll(more) {
    for (const r of more) {
      const k=`${r.item.pageNum}-${r.item.serial}`;
      if (!seen.has(k)) { seen.add(k); results.push(r); }
    }
  }

  // Main query
  if (name && rel) {
    addAll(fuse.search({ $and:[
      { $or:[{name},{nameKan:name}] },
      { $or:[{relativeName:rel},{relativeNameKan:rel}] }
    ]}));
  }

  // Individual field searches
  if (name) { addAll(fuse.search({name})); addAll(fuse.search({nameKan:name})); }
  if (rel)  { addAll(fuse.search({relativeName:rel})); addAll(fuse.search({relativeNameKan:rel})); }

  results.sort((a,b)=>(a.score||1)-(b.score||1));
  showResults(results.slice(0,5), name||rel);
}

function showResults(list, query) {
  const wrap = document.getElementById('roll-out');
  const cards = document.getElementById('roll-cards');
  wrap.style.display = 'block';

  if (!list.length) {
    cards.innerHTML = `<div class="empty"><div class="e-ico">ğŸ”</div><p>No matches for "<b>${query}</b>".<br>Try a shorter name or check spelling.</p></div>`;
    wrap.scrollIntoView({behavior:'smooth',block:'start'});
    return;
  }

  cards.innerHTML = list.map((r,i)=>{
    const e=r.item;
    const pct=Math.max(0,Math.round((1-(r.score||0))*100));
    const bc=pct>=75?'hi':pct>=50?'mid':'lo';
    const bl=pct>=75?'Strong match':pct>=50?'Possible match':'Weak match';
    const dn=e.name||e.nameKan||'â€”';
    const dr=e.relativeName||e.relativeNameKan||'';
    return `
      <div class="result-item${i===0?' top':''}">
        ${i===0?'<div class="best-pin">Best Match</div>':''}
        <div class="result-top-row">
          <div>
            <div class="result-name">${dn}</div>
            ${e.nameKan&&e.name?`<div class="result-rel" style="font-size:13px">${e.nameKan}</div>`:''}
            ${dr?`<div class="result-rel">Father / Husband: ${dr}${e.relativeNameKan&&e.relativeName?' Â· '+e.relativeNameKan:''}</div>`:''}
          </div>
          <span class="badge ${bc}">${pct}% Â· ${bl}</span>
        </div>
        <div class="result-tags">
          ${e.serial?`<div class="tag hl">Serial No. <b>${e.serial}</b></div>`:''}
          ${e.partNo?`<div class="tag hl">Part <b>${e.partNo}</b></div>`:''}
          <div class="tag">Page <b>${e.pageNum}</b></div>
          ${e.age?`<div class="tag">Age <b>${e.age}</b></div>`:''}
          ${e.sex?`<div class="tag">Sex <b>${e.sex}</b></div>`:''}
          ${e.address?`<div class="tag" style="max-width:280px;white-space:normal">Address: <b>${e.address}</b></div>`:''}
        </div>
      </div>`;
  }).join('');

  wrap.scrollIntoView({behavior:'smooth',block:'start'});
}

/* ============================================================
   INIT
============================================================ */
wireFileInput('fi-front','front-btn','front-lbl','front-thumb', file => {
  G.frontFile = file;
  document.getElementById('id-btn').disabled = false;
});

wireFileInput('fi-back','back-btn','back-lbl','back-thumb', file => {
  G.backFile = file;
});

wireFileInput('fi-pdf','pdf-btn','pdf-lbl', null, file => {
  if (file.type !== 'application/pdf') {
    alert('Please upload a PDF file.');
    return;
  }
  G.pdfFile = file;
  document.getElementById('pdf-btn-go').disabled = false;
});

// Enter key in search inputs
document.getElementById('s-name').addEventListener('keydown', e => { if(e.key==='Enter') doSearch(); });
document.getElementById('s-rel').addEventListener('keydown',  e => { if(e.key==='Enter') doSearch(); });
</script>
</body>
</html>
