<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoterTrace</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
html{scroll-behavior:smooth}
body{font-family:'Inter',system-ui,sans-serif;background:#f8fafc;color:#0f172a;min-height:100vh;font-size:14px;line-height:1.5}

.topbar{position:sticky;top:0;z-index:50;background:#fff;border-bottom:1px solid #e2e8f0;display:flex;align-items:center;padding:0 20px;height:52px;gap:8px}
.topbar-logo{font-weight:700;font-size:15px;color:#0f172a;margin-right:12px}
.tab-btn{padding:6px 14px;border-radius:6px;border:none;background:none;font-size:13px;font-weight:500;color:#64748b;cursor:pointer;transition:all .15s}
.tab-btn:hover{background:#f1f5f9;color:#0f172a}
.tab-btn.on{background:#eff6ff;color:#2563eb;font-weight:600}

.page{display:none;max-width:660px;margin:0 auto;padding:28px 20px 80px}
.page.on{display:block}
.page-title{font-size:20px;font-weight:700;margin-bottom:4px}
.page-sub{font-size:13px;color:#64748b;margin-bottom:24px}

.box{background:#fff;border:1px solid #e2e8f0;border-radius:12px;padding:20px;margin-bottom:14px}
.box-head{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.6px;color:#94a3b8;margin-bottom:14px}

/* Upload */
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:12px}
@media(max-width:480px){.upload-grid{grid-template-columns:1fr}}
.slot-label{font-size:11px;font-weight:600;letter-spacing:.4px;margin-bottom:6px;display:block}
.slot-label.f{color:#2563eb}.slot-label.b{color:#7c3aed}

.upload-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:6px;width:100%;padding:20px 12px;border:2px dashed #cbd5e1;border-radius:8px;background:#f8fafc;cursor:pointer;font-family:'Inter',sans-serif;font-size:12px;font-weight:500;color:#64748b;transition:all .15s;text-align:center}
.upload-btn:hover{border-color:#2563eb;background:#eff6ff;color:#2563eb}
.upload-btn.selected{border-color:#16a34a;border-style:solid;background:#f0fdf4;color:#15803d}
.upload-btn .ico{font-size:22px}

.upload-single{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;width:100%;padding:28px 16px;border:2px dashed #cbd5e1;border-radius:8px;background:#f8fafc;cursor:pointer;font-family:'Inter',sans-serif;font-size:13px;font-weight:500;color:#64748b;transition:all .15s;text-align:center}
.upload-single:hover{border-color:#2563eb;background:#eff6ff;color:#2563eb}
.upload-single.selected{border-color:#16a34a;border-style:solid;background:#f0fdf4;color:#15803d}
.upload-single .ico{font-size:28px}

.thumb{width:100%;max-height:110px;object-fit:cover;border-radius:6px;border:1px solid #e2e8f0;margin-top:8px;display:none}

.btn{display:flex;align-items:center;justify-content:center;gap:7px;width:100%;padding:10px 18px;border-radius:8px;border:none;font-family:'Inter',sans-serif;font-size:13px;font-weight:600;cursor:pointer;transition:all .15s;margin-top:12px}
.btn-blue{background:#2563eb;color:#fff}.btn-blue:hover{background:#1d4ed8}.btn-blue:disabled{background:#bfdbfe;cursor:not-allowed}

.prog-wrap{margin-top:10px;display:none}.prog-wrap.on{display:block}
.prog-track{height:4px;background:#e2e8f0;border-radius:2px;overflow:hidden;margin-bottom:5px}
.prog-bar{height:100%;background:#2563eb;border-radius:2px;width:0;transition:width .3s}
.prog-txt{font-size:12px;color:#64748b}

.spin{width:14px;height:14px;border:2px solid rgba(255,255,255,.35);border-top-color:#fff;border-radius:50%;animation:rot .55s linear infinite;flex-shrink:0}
@keyframes rot{to{transform:rotate(360deg)}}

/* Fields */
.field-grid{display:grid;grid-template-columns:1fr 1fr;gap:8px}
@media(max-width:420px){.field-grid{grid-template-columns:1fr}}
.field-item{background:#f8fafc;border-radius:6px;padding:10px 12px}
.field-item.w2{grid-column:1/-1}
.field-k{font-size:10px;font-weight:600;color:#94a3b8;text-transform:uppercase;letter-spacing:.5px;margin-bottom:3px}
.field-v{font-size:14px;font-weight:500;color:#0f172a;line-height:1.4}
.field-v.nil{font-size:12px;color:#cbd5e1;font-style:italic;font-weight:400}

/* Search */
.input-row{display:grid;grid-template-columns:1fr 1fr;gap:10px;margin-bottom:10px}
@media(max-width:460px){.input-row{grid-template-columns:1fr}}
.input-group label{display:block;font-size:12px;font-weight:600;color:#475569;margin-bottom:4px}
.input-group input{width:100%;padding:9px 12px;border:1px solid #e2e8f0;border-radius:7px;font-family:'Inter',sans-serif;font-size:13px;color:#0f172a;background:#fff;outline:none;transition:border-color .15s}
.input-group input:focus{border-color:#2563eb;box-shadow:0 0 0 3px #dbeafe}
.input-group input:disabled{background:#f8fafc;color:#cbd5e1;cursor:not-allowed}

/* Results */
.result-item{background:#fff;border:1px solid #e2e8f0;border-radius:10px;padding:16px;margin-bottom:10px;position:relative;transition:border-color .15s}
.result-item:hover{border-color:#bfdbfe}
.result-item.top{border-color:#2563eb}
.result-top-row{display:flex;align-items:flex-start;justify-content:space-between;margin-bottom:10px;gap:10px}
.result-name{font-size:16px;font-weight:700;color:#0f172a}
.result-sub{font-size:12px;color:#64748b;margin-top:2px;line-height:1.5}
.badge{display:inline-block;padding:3px 9px;border-radius:20px;font-size:11px;font-weight:600;flex-shrink:0}
.badge.hi{background:#dcfce7;color:#15803d}.badge.mid{background:#fef9c3;color:#a16207}.badge.lo{background:#fee2e2;color:#b91c1c}
.result-tags{display:flex;flex-wrap:wrap;gap:6px;margin-top:8px}
.tag{font-size:11px;padding:3px 9px;border-radius:5px;background:#f1f5f9;border:1px solid #e2e8f0;color:#475569}
.tag b{color:#0f172a}.tag.hl{background:#eff6ff;border-color:#bfdbfe;color:#2563eb}.tag.hl b{color:#1d4ed8}
.best-pin{position:absolute;top:-1px;right:12px;background:#2563eb;color:#fff;font-size:10px;font-weight:700;padding:2px 8px;border-radius:0 0 6px 6px;letter-spacing:.3px}

.banner-ok{padding:10px 14px;border-radius:7px;font-size:13px;background:#f0fdf4;border:1px solid #bbf7d0;color:#15803d;font-weight:500}
.notice{display:flex;align-items:center;gap:8px;padding:10px 12px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:7px;font-size:13px;color:#94a3b8;margin-bottom:14px}

.empty{text-align:center;padding:36px 16px;color:#94a3b8}
.empty .e-ico{font-size:30px;margin-bottom:8px}

details{margin-top:12px}
details summary{font-size:12px;color:#94a3b8;cursor:pointer;user-select:none}
details pre{margin-top:8px;background:#f8fafc;border:1px solid #e2e8f0;border-radius:6px;padding:10px;font-size:10px;color:#64748b;white-space:pre-wrap;word-break:break-word;max-height:160px;overflow-y:auto;font-family:monospace}

::-webkit-scrollbar{width:5px}
::-webkit-scrollbar-thumb{background:#e2e8f0;border-radius:3px}
</style>
</head>
<body>

<div class="topbar">
  <span class="topbar-logo">VoterTrace</span>
  <button class="tab-btn on" id="t1" onclick="go('voter-id','t1')">Voter ID Reader</button>
  <button class="tab-btn"    id="t2" onclick="go('roll-search','t2')">Electoral Roll Search</button>
</div>

<!-- PAGE 1: VOTER ID -->
<div class="page on" id="voter-id">
  <p class="page-title">Voter ID Reader</p>
  <p class="page-sub">Upload your voter ID card to extract all details.</p>

  <div class="box">
    <div class="box-head">Upload Card Images</div>
    <div class="upload-grid">
      <div>
        <span class="slot-label f">‚ñ≤ Front side</span>
        <button class="upload-btn" id="front-btn" onclick="document.getElementById('fi-front').click()">
          <span class="ico">ü™™</span>
          <span id="front-lbl">Click to choose image</span>
        </button>
        <input type="file" id="fi-front" accept="image/*" style="display:none">
        <img id="front-thumb" class="thumb" alt="">
      </div>
      <div>
        <span class="slot-label b">‚ñº Back side</span>
        <button class="upload-btn" id="back-btn" onclick="document.getElementById('fi-back').click()">
          <span class="ico">üè†</span>
          <span id="back-lbl">Click to choose image</span>
        </button>
        <input type="file" id="fi-back" accept="image/*" style="display:none">
        <img id="back-thumb" class="thumb" alt="">
      </div>
    </div>
    <div class="prog-wrap" id="id-prog">
      <div class="prog-track"><div class="prog-bar" id="id-bar"></div></div>
      <div class="prog-txt" id="id-txt">Scanning‚Ä¶</div>
    </div>
    <button class="btn btn-blue" id="id-btn" disabled onclick="scanId()">Scan Voter ID</button>
  </div>

  <div id="id-out" style="display:none">
    <div class="box">
      <div class="box-head">Extracted Details</div>
      <div class="field-grid" id="id-fields"></div>
      <details>
        <summary>View raw scanned text</summary>
        <pre id="id-raw"></pre>
      </details>
    </div>
  </div>
</div>

<!-- PAGE 2: ELECTORAL ROLL SEARCH -->
<div class="page" id="roll-search">
  <p class="page-title">Electoral Roll Search</p>
  <p class="page-sub">Upload the electoral roll PDF, then search by name to find voter details.</p>

  <div class="box">
    <div class="box-head">Step 1 ‚Äî Upload Electoral Roll PDF</div>
    <button class="upload-single" id="pdf-btn" onclick="document.getElementById('fi-pdf').click()">
      <span class="ico">üìÑ</span>
      <span id="pdf-lbl">Click to choose PDF file</span>
    </button>
    <input type="file" id="fi-pdf" accept="application/pdf" style="display:none">
    <div class="prog-wrap" id="pdf-prog">
      <div class="prog-track"><div class="prog-bar" id="pdf-bar"></div></div>
      <div class="prog-txt" id="pdf-txt">Processing‚Ä¶</div>
    </div>
    <button class="btn btn-blue" id="pdf-btn-go" disabled onclick="scanPdf()">Process PDF</button>
  </div>

  <div class="box" id="search-box">
    <div class="box-head">Step 2 ‚Äî Search for a Voter</div>
    <div class="notice" id="pdf-not-ready">
      <span style="font-size:16px">‚¨ÜÔ∏è</span>
      <span>Upload and process the PDF above first, then search here.</span>
    </div>
    <div class="banner-ok" id="pdf-ready-banner" style="display:none;margin-bottom:14px"></div>
    <div class="input-row">
      <div class="input-group">
        <label for="s-name">Voter Name (‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å)</label>
        <input id="s-name" type="text" placeholder="Enter name in Kannada or English" disabled>
      </div>
      <div class="input-group">
        <label for="s-rel">Father / Husband Name (‡≤§‡≤Ç‡≤¶‡≥Ü / ‡≤™‡≤§‡≤ø)</label>
        <input id="s-rel" type="text" placeholder="Enter relative's name" disabled>
      </div>
    </div>
    <button class="btn btn-blue" style="margin-top:0" id="search-btn" disabled onclick="doSearch()">Search</button>
  </div>

  <div id="roll-out" style="display:none">
    <div id="roll-cards"></div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/fuse.js/7.0.0/fuse.min.js"></script>
<script>
pdfjsLib.GlobalWorkerOptions.workerSrc =
  'https://cdnjs.cloudflare.com/ajax/libs/pdf.js/3.11.174/pdf.worker.min.js';

const G = { frontFile:null, backFile:null, pdfFile:null, entries:[] };

// ‚îÄ‚îÄ NAV ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function go(pageId, tabId) {
  document.querySelectorAll('.page').forEach(p=>p.classList.remove('on'));
  document.querySelectorAll('.tab-btn').forEach(b=>b.classList.remove('on'));
  document.getElementById(pageId).classList.add('on');
  document.getElementById(tabId).classList.add('on');
}

// ‚îÄ‚îÄ FILE INPUT WIRING ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// Reliable pattern: button.onclick ‚Üí input.click(), input.onchange reads file
function wireFile(inputId, btnId, lblId, thumbId, onFile) {
  const inp = document.getElementById(inputId);
  const btn = document.getElementById(btnId);
  const lbl = document.getElementById(lblId);
  const thumb = thumbId ? document.getElementById(thumbId) : null;

  inp.addEventListener('change', function() {
    const file = this.files && this.files[0];
    if (!file) return;
    btn.classList.add('selected');
    lbl.textContent = file.name.length > 30 ? file.name.slice(0,28)+'‚Ä¶' : file.name;
    if (thumb && file.type.startsWith('image/')) {
      const fr = new FileReader();
      fr.onload = e => { thumb.src = e.target.result; thumb.style.display = 'block'; };
      fr.readAsDataURL(file);
    }
    onFile(file);
  });

  // Drag-drop support
  btn.addEventListener('dragover', e => { e.preventDefault(); btn.style.borderColor='#2563eb'; });
  btn.addEventListener('dragleave', () => { btn.style.borderColor=''; });
  btn.addEventListener('drop', e => {
    e.preventDefault(); btn.style.borderColor='';
    const file = e.dataTransfer.files && e.dataTransfer.files[0];
    if (!file) return;
    try { const dt=new DataTransfer(); dt.items.add(file); inp.files=dt.files; } catch(x){}
    inp.dispatchEvent(new Event('change'));
  });
}

// ‚îÄ‚îÄ UTILS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
let _T = null;
function getTess() {
  if (_T) return _T;
  _T = new Promise((res,rej) => {
    if (window.Tesseract) { res(window.Tesseract); return; }
    const s = document.createElement('script');
    s.src = 'https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js';
    s.onload = () => res(window.Tesseract);
    s.onerror = rej;
    document.head.appendChild(s);
  });
  return _T;
}

function setPb(barId, txtId, pct, msg) {
  const b=document.getElementById(barId), t=document.getElementById(txtId);
  if (b) b.style.width=Math.min(100,Math.max(0,pct))+'%';
  if (t&&msg!==undefined) t.textContent=msg;
}

function clean(s){ return (s||'').replace(/\s+/g,' ').trim(); }

// ‚îÄ‚îÄ VOTER ID SCAN ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
async function scanId() {
  if (!G.frontFile) { alert('Please choose the front image first.'); return; }
  const btn=document.getElementById('id-btn');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span>Scanning‚Ä¶';
  document.getElementById('id-prog').classList.add('on');

  try {
    const T = await getTess();

    // Pass 1: front, English + Hindi
    setPb('id-bar','id-txt',5,'Reading front (English)‚Ä¶');
    const w1 = await T.createWorker(['eng','hin'],1,{
      logger:m=>{ if(m.status==='recognizing text') setPb('id-bar','id-txt',5+m.progress*22,'Reading front (English)‚Ä¶'); }
    });
    const frontEng = (await w1.recognize(G.frontFile)).data.text;
    await w1.terminate();

    // Pass 2: front, Kannada
    setPb('id-bar','id-txt',29,'Reading front (Kannada)‚Ä¶');
    const w2 = await T.createWorker(['kan','eng'],1,{
      logger:m=>{ if(m.status==='recognizing text') setPb('id-bar','id-txt',29+m.progress*22,'Reading front (Kannada)‚Ä¶'); }
    });
    const frontKan = (await w2.recognize(G.frontFile)).data.text;
    await w2.terminate();

    let backEng='', backKan='';
    if (G.backFile) {
      setPb('id-bar','id-txt',53,'Reading back (English)‚Ä¶');
      const w3 = await T.createWorker(['eng','hin'],1,{
        logger:m=>{ if(m.status==='recognizing text') setPb('id-bar','id-txt',53+m.progress*18,'Reading back (English)‚Ä¶'); }
      });
      backEng = (await w3.recognize(G.backFile)).data.text;
      await w3.terminate();

      setPb('id-bar','id-txt',73,'Reading back (Kannada)‚Ä¶');
      const w4 = await T.createWorker(['kan','eng'],1,{
        logger:m=>{ if(m.status==='recognizing text') setPb('id-bar','id-txt',73+m.progress*18,'Reading back (Kannada)‚Ä¶'); }
      });
      backKan = (await w4.recognize(G.backFile)).data.text;
      await w4.terminate();
    }

    setPb('id-bar','id-txt',95,'Extracting details‚Ä¶');
    const f = extractId(frontEng, frontKan, backEng, backKan);
    renderIdFields(f, frontEng+'\n\n---KANNADA---\n\n'+frontKan+(backEng?'\n\n---BACK---\n\n'+backEng+'\n\n'+backKan:''));
    setPb('id-bar','id-txt',100,'Done');

  } catch(e) {
    console.error(e);
    alert('Scan error: '+e.message);
  } finally {
    btn.disabled=false; btn.innerHTML='Scan Voter ID';
  }
}

// ‚îÄ‚îÄ EXTRACT VOTER ID FIELDS ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function extractId(fe, fk, be, bk) {
  be=be||''; bk=bk||''; fk=fk||'';
  const f = {
    electorName:'', electorNameKan:'',
    fatherName:'',  fatherNameKan:'',
    sex:'', dob:'',
    epicNo:'', addr:'', taluk:'', dist:'',
    part:'', serial:''
  };

  // ‚îÄ‚îÄ EPIC No. ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Pattern: 3 uppercase letters + 7-8 alphanum (BCW0666909)
  const epicM = (fe+' '+be).match(/\b([A-Z]{3}[O0][0-9]{6,7})\b/i)
             || (fe+' '+be).match(/IDENTITY\s+CARD\s+([A-Z0-9]{9,10})/i);
  if (epicM) f.epicNo = epicM[1].toUpperCase().replace(/O(?=[0-9])/g,'0');

  // ‚îÄ‚îÄ ELECTOR'S NAME (English) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Card has: "Elector's Name : Syed Abdul Naseer"
  const nameM = fe.match(/elector'?s?\s*name\s*[:\-]\s*([A-Z][A-Za-z .']{2,50})/i)
             || fe.match(/voter'?s?\s*name\s*[:\-]\s*([A-Z][A-Za-z .']{2,50})/i);
  if (nameM) f.electorName = clean(nameM[1]);

  // ‚îÄ‚îÄ FATHER'S NAME (English) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Card has: "Father's Name : Abdul Basith"
  const fatherM = fe.match(/father'?s?\s*name\s*[:\-]\s*([A-Z][A-Za-z .']{2,50})/i)
               || fe.match(/husband'?s?\s*name\s*[:\-]\s*([A-Z][A-Za-z .']{2,50})/i);
  if (fatherM) f.fatherName = clean(fatherM[1]);

  // ‚îÄ‚îÄ ELECTOR'S NAME (Kannada) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Card has: "‡≤Æ‡≤§‡≤¶‡≤æ‡≤∞‡≤∞ ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å : ‡≤∏‡≥ç‡≤Ø‡≤Ø‡≤¶‡≥ç ‡≤Ö‡≤¨‡≥ç‡≤¨‡≥Å‡≤≤‡≥ç ‡≤®‡≤∏‡≥Ä‡≤∞‡≥ç"
  // OCR often puts label and value on same line OR value on next line(s)
  // Strategy: find the label, collect all Kannada text following it
  f.electorNameKan = extractKannadaAfterLabel(fk,
    /‡≤Æ‡≤§‡≤¶‡≤æ‡≤∞‡≤∞\s*‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å|‡≤Æ‡≤§‡≤¶‡≤æ‡≤∞\s*‡≤π‡≥Ü‡≤∏‡≤∞/);

  // ‚îÄ‚îÄ FATHER'S NAME (Kannada) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Card has: "‡≤§‡≤Ç‡≤¶‡≥Ü‡≤Ø ‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å : ‡≤Ö‡≤¨‡≥ç‡≤¨‡≥Å‡≤≤‡≥ç ‡≤¨‡≤æ‡≤∏‡≤ø‡≤§‡≥ç"
  f.fatherNameKan = extractKannadaAfterLabel(fk,
    /‡≤§‡≤Ç‡≤¶‡≥Ü‡≤Ø\s*‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å|‡≤§‡≤Ç‡≤¶‡≥Ü\s*‡≤π‡≥Ü‡≤∏‡≤∞|‡≤™‡≤§‡≤ø‡≤Ø\s*‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å/);

  // Fallback Kannada extraction using English name word count as guide
  if (!f.electorNameKan || !f.fatherNameKan) {
    kanFallback(fk, f);
  }

  // ‚îÄ‚îÄ SEX ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  const sexM = (fe+' '+fk).match(/\bsex\s*[:\-]?\s*(male|female|m|f)\b/i)
            || (fe+' '+fk).match(/‡≤≤‡≤ø‡≤Ç‡≤ó\s*[:\-]?\s*(‡≤™‡≥Å|‡≤Æ)/);
  if (sexM) {
    const s = sexM[1].toLowerCase();
    f.sex = (s==='m'||s==='male'||s==='‡≤™‡≥Å') ? 'Male' : 'Female';
  }

  // ‚îÄ‚îÄ DATE OF BIRTH (derived) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  // Card says: "Age as on 1.1.2002 : 25"
  // ‚Üí DOB year = refYear - ageAtRef = 2002 - 25 = 1977
  // Show as: "~ 1977 (age 25 as on 1.1.2002)"
  const ageAsOnM =
    (fe+' '+fk).match(/age\s+as\s+on\s+(\d{1,2})[./](\d{1,2})[./](\d{4})\s*[:\-]\s*(\d{1,3})/i) ||
    (fe+' '+fk).match(/age\s+as\s+on\s+[\d./]*(\d{4})\s*[:\-]?\s*(\d{1,3})/i);

  if (ageAsOnM) {
    let refYear, ageAtRef;
    if (ageAsOnM.length >= 5) {
      // Full match: day.month.year : age
      refYear  = parseInt(ageAsOnM[3]);
      ageAtRef = parseInt(ageAsOnM[4]);
    } else {
      refYear  = parseInt(ageAsOnM[1]);
      ageAtRef = parseInt(ageAsOnM[2]);
    }
    if (refYear>1950 && refYear<2030 && ageAtRef>0 && ageAtRef<120) {
      const dobYear = refYear - ageAtRef;
      f.dob = `~${dobYear} (was ${ageAtRef} as on 1.1.${refYear})`;
    }
  }

  // ‚îÄ‚îÄ ADDRESS (back side only) ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
  if (be) {
    const addrM = be.match(/address\s*[:\-]\s*([^\n]{5,80})/i);
    if (addrM) f.addr = clean(addrM[1]);
    const talukM = be.match(/taluk\s*[:\-]\s*([A-Za-z ()\-]{3,50})/i);
    if (talukM) f.taluk = clean(talukM[1]);
    const distM = be.match(/district\s*[:\-]\s*([A-Za-z ]{3,40})/i);
    if (distM) f.dist = clean(distM[1]);
    const pts=[];
    if (f.addr) pts.push(f.addr);
    if (f.taluk) pts.push(f.taluk+' Taluk');
    if (f.dist) pts.push(f.dist+' District');
    if (pts.length) f.addr = pts.join(', ');

    // Part/Serial: back has "238 / 882" at end of page
    const slM = be.match(/\b(\d{1,4})\s*\/\s*(\d{1,4})\s*$/m);
    if (slM) { f.serial=slM[1]; f.part=slM[2]; }
  }

  return f;
}

// Collect Kannada text that comes after a given Kannada label on same or next lines
function extractKannadaAfterLabel(kanText, labelRe) {
  const lines = kanText.split('\n').map(l=>l.trim());
  for (let i=0; i<lines.length; i++) {
    if (!labelRe.test(lines[i])) continue;
    // Remove the label part, get remainder of same line
    const sameLine = lines[i].replace(labelRe,'').replace(/^[\s:‚Äì\-|]+/,'').trim();
    const parts = sameLine ? [sameLine] : [];
    // Collect continuation lines that are Kannada-dominant
    for (let j=i+1; j<lines.length && j<i+4; j++) {
      const nx = lines[j];
      if (!nx) break;
      // Stop at next label line (has colon and Kannada label keywords)
      if ((/:/.test(nx)) && /‡≤§‡≤Ç‡≤¶‡≥Ü|‡≤™‡≤§‡≤ø|‡≤Æ‡≤§‡≤¶‡≤æ‡≤∞|‡≤≤‡≤ø‡≤Ç‡≤ó|‡≤µ‡≤Ø|‡≤ó‡≥ç‡≤∞‡≤æ‡≤Æ|‡≤µ‡≤ø‡≤≥‡≤æ‡≤∏/.test(nx)) break;
      if (/elector|father|husband|sex|age|address/i.test(nx)) break;
      if (/[\u0C80-\u0CFF]{2,}/.test(nx)) parts.push(nx);
      else break;
    }
    const result = parts.join(' ').trim();
    // Clean up leading pipe/number artifacts from OCR: "| : ‡≤∏‡≥ç‡≤Ø‡≤Ø‡≤¶‡≥ç‚Ä¶" ‚Üí "‡≤∏‡≥ç‡≤Ø‡≤Ø‡≤¶‡≥ç‚Ä¶"
    return result.replace(/^[\d\s|.:‚Äì\-]+/, '').trim();
  }
  return '';
}

// Fallback: use English name/father word counts to align Kannada lines
function kanFallback(fk, f) {
  const kanLines = fk.split('\n').map(l=>l.trim()).filter(l=>
    /[\u0C80-\u0CFF]{3,}/.test(l) && l.length>3 && l.length<80 &&
    !/‡≤≠‡≤æ‡≤∞‡≤§|‡≤ö‡≥Å‡≤®‡≤æ|‡≤ó‡≥Å‡≤∞‡≥Å‡≤§‡≤ø‡≤®|‡≤Ü‡≤Ø‡≥ã‡≤ó|‡≤ó‡≥ç‡≤∞‡≤æ‡≤Æ|‡≤≤‡≤ø‡≤Ç‡≤ó/.test(l)
  );

  const nWords = f.electorName ? f.electorName.split(/\s+/).length : 3;
  const rWords = f.fatherName  ? f.fatherName.split(/\s+/).length  : 2;

  let allKanWords = [];
  for (const ln of kanLines) {
    const w = ln.split(/\s+/).filter(w=>/[\u0C80-\u0CFF]/.test(w));
    allKanWords.push(...w);
  }

  if (!f.electorNameKan && allKanWords.length >= nWords) {
    f.electorNameKan = allKanWords.slice(0, nWords).join(' ');
    allKanWords = allKanWords.slice(nWords);
  }
  if (!f.fatherNameKan && allKanWords.length >= 1) {
    f.fatherNameKan = allKanWords.slice(0, rWords).join(' ');
  }
}

function renderIdFields(f, raw) {
  // Build rows using the exact label language from the card
  const rows = [
    { k:"Elector's Name",         v: f.electorName,    w:false },
    { k:"Elector's Name (Kannada)", v: f.electorNameKan, w:false, h:!f.electorNameKan },
    { k:"Father's Name",          v: f.fatherName,     w:false },
    { k:"Father's Name (Kannada)", v: f.fatherNameKan,  w:false, h:!f.fatherNameKan },
    { k:"Sex",                    v: f.sex,            w:false },
    { k:"Year of Birth",          v: f.dob,            w:false, h:!f.dob },
    { k:"EPIC No.",               v: f.epicNo,         w:false },
    { k:"Address",                v: f.addr,           w:true,  h:!f.addr },
    { k:"Part No.",               v: f.part,           w:false, h:!f.part },
    { k:"Serial No.",             v: f.serial,         w:false, h:!f.serial },
  ].filter(r=>!r.h);

  document.getElementById('id-fields').innerHTML = rows.map(r=>`
    <div class="field-item${r.w?' w2':''}">
      <div class="field-k">${r.k}</div>
      <div class="field-v${r.v?'':' nil'}">${r.v||'Not found'}</div>
    </div>`).join('');
  document.getElementById('id-raw').textContent = raw;
  document.getElementById('id-out').style.display='block';
  document.getElementById('id-out').scrollIntoView({behavior:'smooth',block:'start'});
}

// ‚îÄ‚îÄ PDF SCAN ‚Äî Native text extraction (no OCR, ~5 seconds for 52 pages) ‚îÄ‚îÄ
async function scanPdf() {
  if (!G.pdfFile) { alert('Please choose a PDF file first.'); return; }
  const btn=document.getElementById('pdf-btn-go');
  btn.disabled=true; btn.innerHTML='<span class="spin"></span>Processing‚Ä¶';
  document.getElementById('pdf-prog').classList.add('on');
  G.entries=[];

  try {
    const buf = await G.pdfFile.arrayBuffer();
    const pdf = await pdfjsLib.getDocument({data:buf}).promise;
    const total = pdf.numPages;
    setPb('pdf-bar','pdf-txt',2,`Extracting text from ${total} pages‚Ä¶`);

    // Extract ALL pages in parallel using PDF.js native text layer
    // This is 100x faster than OCR ‚Äî no image conversion needed
    const pagePromises = [];
    for (let pn=1; pn<=total; pn++) {
      pagePromises.push(
        pdf.getPage(pn).then(pg =>
          pg.getTextContent().then(tc => ({ pn, tc }))
        )
      );
    }

    // Process in batches of 10 to update progress
    const batchSize = 10;
    let done = 0;
    const allPageData = [];

    for (let i=0; i<pagePromises.length; i+=batchSize) {
      const batch = await Promise.all(pagePromises.slice(i, i+batchSize));
      allPageData.push(...batch);
      done = Math.min(allPageData.length, total);
      setPb('pdf-bar','pdf-txt', 2+Math.round(done/total*85), `Extracted ${done} of ${total} pages‚Ä¶`);
    }

    setPb('pdf-bar','pdf-txt',90,'Parsing voter entries‚Ä¶');

    // Parse each page
    for (const {pn, tc} of allPageData.sort((a,b)=>a.pn-b.pn)) {
      const entries = parsePageNative(tc, pn);
      G.entries.push(...entries);
    }

    // Sort by page then serial
    G.entries.sort((a,b)=>(a.pageNum-b.pageNum)||((+a.serial||0)-(+b.serial||0)));

    setPb('pdf-bar','pdf-txt',100,`Done ‚Äî ${G.entries.length} voter entries found across ${total} pages`);

    // Enable search
    document.getElementById('pdf-not-ready').style.display='none';
    const rb = document.getElementById('pdf-ready-banner');
    rb.textContent = `‚úì ${G.entries.length} voter entries loaded from ${total} pages. Enter a name to search.`;
    rb.style.display='block';
    document.getElementById('s-name').disabled=false;
    document.getElementById('s-rel').disabled=false;
    document.getElementById('search-btn').disabled=false;
    document.getElementById('search-box').scrollIntoView({behavior:'smooth',block:'start'});

  } catch(e) {
    console.error(e);
    alert('PDF error: '+e.message);
  } finally {
    btn.disabled=false; btn.innerHTML='Process PDF';
  }
}

// ‚îÄ‚îÄ PARSE NATIVE PDF TEXT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
// PDF.js getTextContent() returns items with .str and .transform (position)
// Electoral roll PDFs have a structured table layout we can reconstruct
function parsePageNative(tc, pageNum) {
  const entries = [];

  // Get all text items with their positions
  const items = tc.items
    .filter(i => i.str && i.str.trim())
    .map(i => ({
      text: i.str.trim(),
      x: Math.round(i.transform[4]),
      y: Math.round(i.transform[5]),
      // font size from transform matrix
      h: Math.round(Math.abs(i.transform[3])||Math.abs(i.transform[0]))
    }));

  if (!items.length) return entries;

  // Find part number from header area
  let partNo = '';
  const topItems = items.filter(i => i.y > (Math.max(...items.map(x=>x.y)) - 80));
  for (const it of topItems) {
    const pm = it.text.match(/(?:part|‡≤≠‡≤æ‡≤ó|Part\s*No)\s*[:\-#.]?\s*(\d+)/i);
    if (pm) { partNo=pm[1]; break; }
  }
  if (!partNo) {
    // Try any item
    for (const it of items.slice(0,20)) {
      const pm = it.text.match(/(\d+)/);
      if (pm && it.text.match(/part|‡≤≠‡≤æ‡≤ó/i)) { partNo=pm[1]; break; }
    }
  }

  // Group items by approximate Y row (within 4px = same line)
  const rows = groupByRows(items, 4);

  // Reconstruct full text with row breaks ‚Äî then use the text parser
  const fullText = rows.map(row =>
    row.sort((a,b)=>a.x-b.x).map(i=>i.text).join(' ')
  ).join('\n');

  // Try structured parsing first (numbered entries)
  const structured = parseStructured(fullText, partNo, pageNum);
  if (structured.length > 0) return structured;

  // Fall back to block-based parsing
  return parseBlocks(rows, partNo, pageNum);
}

function groupByRows(items, tolerance) {
  const sorted = [...items].sort((a,b) => b.y - a.y); // top to bottom
  const rows = [];
  for (const item of sorted) {
    const row = rows.find(r => Math.abs(r[0].y - item.y) <= tolerance);
    if (row) row.push(item);
    else rows.push([item]);
  }
  return rows;
}

function parseStructured(text, partNo, pageNum) {
  // Match numbered entries like "1.", "1)", or standalone serial numbers
  const entries = [];
  const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);

  let i=0;
  while (i<lines.length) {
    // Match: "1. Name" or "1) Name" or serial at start
    const m = lines[i].match(/^(\d{1,4})[.)]\s*(.*)$/) ||
               lines[i].match(/^(\d{1,4})\s+(.{4,})$/); // "1  NameHere"
    if (m && parseInt(m[1]) >= 1 && parseInt(m[1]) <= 9999) {
      const serial = m[1];
      const firstLine = m[2].trim();
      const block = firstLine ? [firstLine] : [];
      let j = i+1;
      // Collect continuation lines (up to 10, stop at next numbered entry)
      while (j<lines.length && j<i+12) {
        const next = lines[j];
        if (/^(\d{1,4})[.)]/.test(next) || /^(\d{1,4})\s+[A-Z\u0C80-\u0CFF]/.test(next)) break;
        if (next.length > 0) block.push(next);
        j++;
      }
      if (block.length>0) {
        entries.push(buildEntry(block, serial, partNo, pageNum));
      }
      i=j;
    } else {
      i++;
    }
  }
  return entries;
}

function parseBlocks(rows, partNo, pageNum) {
  // For PDFs without numbered entries, look for voter blocks by:
  // - Serial number column (left-most narrow column with single number)
  // - Name block (Kannada + English name + relative + age/sex)
  const entries = [];

  // Identify columns by X position clustering
  const xPositions = rows.flat().map(i=>i.x);
  const minX = Math.min(...xPositions);
  const maxX = Math.max(...xPositions);

  // Typical electoral roll: serial in leftmost ~80px, then name block
  const serialColMax = minX + (maxX - minX) * 0.15;

  let currentEntry = null;
  let currentBlock = [];

  for (const row of rows) {
    const rowText = row.sort((a,b)=>a.x-b.x).map(i=>i.text).join(' ').trim();
    if (!rowText) continue;

    const leftItems = row.filter(i=>i.x <= serialColMax);
    const rightItems = row.filter(i=>i.x > serialColMax);

    // Check if left column has a bare serial number
    const leftText = leftItems.map(i=>i.text).join(' ').trim();
    const serialM = leftText.match(/^(\d{1,4})$/);

    if (serialM) {
      // Save previous entry
      if (currentEntry && currentBlock.length) {
        entries.push(buildEntry(currentBlock, currentEntry, partNo, pageNum));
      }
      currentEntry = serialM[1];
      currentBlock = [];
      const rightText = rightItems.map(i=>i.text).join(' ').trim();
      if (rightText) currentBlock.push(rightText);
    } else if (currentEntry) {
      // Continuation of current entry
      if (rowText.length > 1) currentBlock.push(rowText);
    }
  }

  // Save last entry
  if (currentEntry && currentBlock.length) {
    entries.push(buildEntry(currentBlock, currentEntry, partNo, pageNum));
  }

  // If still no entries, try regex on reconstructed text
  if (!entries.length) {
    const fullText = rows.map(r=>r.sort((a,b)=>a.x-b.x).map(i=>i.text).join(' ')).join('\n');
    return parseByAge(fullText, partNo, pageNum);
  }

  return entries;
}

// Last resort: find entries anchored by age field
function parseByAge(text, partNo, pageNum) {
  const entries = [];
  const lines = text.split('\n').map(l=>l.trim()).filter(Boolean);
  for (let k=0; k<lines.length; k++) {
    const am = lines[k].match(/(?:‡≤µ‡≤Ø‡≤∏‡≥ç‡≤∏‡≥Å|Age|‡≤µ‡≤Ø)\s*[:\-]?\s*(\d{2,3})/i);
    if (am && parseInt(am[1])>0 && parseInt(am[1])<120) {
      const block=[];
      for (let b=Math.max(0,k-4); b<k; b++) block.push(lines[b]);
      entries.push(buildEntry(block, String(entries.length+1), partNo, pageNum));
    }
  }
  return entries;
}

function buildEntry(block, serial, partNo, pageNum) {
  const e = {
    serial, partNo, pageNum,
    nameKan:'', name:'',
    relativeKan:'', relative:'',
    age:'', sex:'', address:''
  };

  for (const ln of block) {
    if (!ln || ln.length < 2) continue;

    // Age field
    const ageM = ln.match(/(?:‡≤µ‡≤Ø‡≤∏‡≥ç‡≤∏‡≥Å|‡≤µ‡≤Ø|Age)\s*[:\-]?\s*(\d{2,3})/i);
    if (ageM && !e.age) { const n=parseInt(ageM[1]); if(n>0&&n<120){e.age=String(n); continue;} }

    // Sex field  
    const sexM = ln.match(/(?:‡≤≤‡≤ø‡≤Ç‡≤ó|Sex)\s*[:\-]?\s*(‡≤™‡≥Å|‡≤Æ|Male|Female|M|F)/i);
    if (sexM && !e.sex) { e.sex=sexM[1]; continue; }

    // Relative label
    const relM = ln.match(/(?:‡≤§‡≤Ç‡≤¶‡≥Ü|‡≤™‡≤§‡≤ø|S\/O|D\/O|W\/O|Father|Husband)\s*[:\-]?\s*(.+)/i);
    if (relM && !e.relative && !e.relativeKan) {
      const v=clean(relM[1]);
      if (/[\u0C80-\u0CFF]{3,}/.test(v)) e.relativeKan=v;
      else if (v.length>1) e.relative=v;
      continue;
    }

    // Classify line: Kannada or English
    const kanChars = (ln.match(/[\u0C80-\u0CFF]/g)||[]).length;
    const totalChars = ln.replace(/\s/g,'').length;
    const isKannada = totalChars>0 && (kanChars/totalChars)>0.4;

    if (isKannada) {
      if (!e.nameKan) e.nameKan = ln;
      else if (!e.relativeKan) e.relativeKan = ln;
      else e.address = (e.address?e.address+' ':'')+ln;
    } else {
      if (!e.name && /[A-Za-z]{2,}/.test(ln)) e.name = ln;
      else if (!e.relative && /[A-Za-z]{2,}/.test(ln)) e.relative = ln;
      else if (ln.length>2) e.address = (e.address?e.address+' ':'')+ln;
    }
  }
  return e;
}

// ‚îÄ‚îÄ SEARCH ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
function doSearch() {
  const name = document.getElementById('s-name').value.trim();
  const rel  = document.getElementById('s-rel').value.trim();
  if (!name && !rel) { alert('Enter at least a name to search.'); return; }
  if (!G.entries.length) { alert('Please process a PDF first.'); return; }

  // Determine if input is Kannada
  const isKannada = str => /[\u0C80-\u0CFF]/.test(str);

  const fuse = new Fuse(G.entries, {
    includeScore: true,
    threshold: 0.40,       // Tighter threshold for better precision
    ignoreLocation: true,
    useExtendedSearch: false,
    keys: [
      // Weight Kannada higher when input is Kannada
      { name: 'nameKan',     weight: isKannada(name) ? 0.50 : 0.20 },
      { name: 'name',        weight: isKannada(name) ? 0.15 : 0.45 },
      { name: 'relativeKan', weight: isKannada(rel||name) ? 0.25 : 0.10 },
      { name: 'relative',    weight: isKannada(rel||name) ? 0.10 : 0.25 },
    ]
  });

  const seen = new Set();
  let results = [];

  function add(more) {
    for (const r of more) {
      const k=`${r.item.pageNum}-${r.item.serial}`;
      if (!seen.has(k)) { seen.add(k); results.push(r); }
    }
  }

  // Primary search with both fields
  if (name && rel) {
    add(fuse.search({ $and:[
      { $or: isKannada(name)
          ? [{nameKan:name},{name}]
          : [{name},{nameKan:name}] },
      { $or: isKannada(rel)
          ? [{relativeKan:rel},{relative:rel}]
          : [{relative:rel},{relativeKan:rel}] }
    ]}));
  }

  // Individual field searches to catch partial matches
  if (name) {
    add(isKannada(name)
      ? fuse.search({nameKan:name})
      : fuse.search({name}));
    add(isKannada(name)
      ? fuse.search({name})
      : fuse.search({nameKan:name}));
  }
  if (rel) {
    add(isKannada(rel)
      ? fuse.search({relativeKan:rel})
      : fuse.search({relative:rel}));
  }

  results.sort((a,b)=>(a.score||1)-(b.score||1));
  showResults(results.slice(0,5), name||rel);
}

function showResults(list, query) {
  const wrap=document.getElementById('roll-out');
  const cards=document.getElementById('roll-cards');
  wrap.style.display='block';

  if (!list.length) {
    cards.innerHTML=`<div class="empty"><div class="e-ico">üîç</div><p>No matches found for "<b>${query}</b>".<br>Try different spelling or Kannada script.</p></div>`;
    wrap.scrollIntoView({behavior:'smooth',block:'start'});
    return;
  }

  cards.innerHTML = list.map((r,i) => {
    const e=r.item;
    const pct=Math.max(0,Math.round((1-(r.score||0))*100));
    const bc=pct>=75?'hi':pct>=50?'mid':'lo';
    const displayName = e.nameKan || e.name || '‚Äî';
    const displayNameAlt = (e.nameKan&&e.name) ? e.name : '';
    const displayRel = e.relativeKan || e.relative || '';
    const displayRelAlt = (e.relativeKan&&e.relative) ? e.relative : '';

    return `
      <div class="result-item${i===0?' top':''}">
        ${i===0?'<div class="best-pin">Best Match</div>':''}
        <div class="result-top-row">
          <div style="min-width:0">
            <div class="result-name">${displayName}</div>
            ${displayNameAlt?`<div class="result-sub">${displayNameAlt}</div>`:''}
            ${displayRel?`<div class="result-sub">Father/Husband: ${displayRel}${displayRelAlt?' ¬∑ '+displayRelAlt:''}</div>`:''}
          </div>
          <span class="badge ${bc}" style="flex-shrink:0">${pct}%</span>
        </div>
        <div class="result-tags">
          ${e.serial?`<div class="tag hl">Serial No. <b>${e.serial}</b></div>`:''}
          ${e.partNo?`<div class="tag hl">Part <b>${e.partNo}</b></div>`:''}
          <div class="tag">Page <b>${e.pageNum}</b></div>
          ${e.age?`<div class="tag">Age <b>${e.age}</b></div>`:''}
          ${e.sex?`<div class="tag">Sex <b>${e.sex}</b></div>`:''}
          ${e.address?`<div class="tag" style="max-width:260px;white-space:normal">üìç ${e.address}</div>`:''}
        </div>
      </div>`;
  }).join('');

  wrap.scrollIntoView({behavior:'smooth',block:'start'});
}

// ‚îÄ‚îÄ INIT ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
wireFile('fi-front','front-btn','front-lbl','front-thumb', file => {
  G.frontFile=file;
  document.getElementById('id-btn').disabled=false;
});

wireFile('fi-back','back-btn','back-lbl','back-thumb', file => {
  G.backFile=file;
});

wireFile('fi-pdf','pdf-btn','pdf-lbl',null, file => {
  if (file.type!=='application/pdf') { alert('Please upload a PDF file.'); return; }
  G.pdfFile=file;
  document.getElementById('pdf-btn-go').disabled=false;
});

document.getElementById('s-name').addEventListener('keydown', e=>{ if(e.key==='Enter') doSearch(); });
document.getElementById('s-rel').addEventListener('keydown',  e=>{ if(e.key==='Enter') doSearch(); });
</script>
</body>
</html>
