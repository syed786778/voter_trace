<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>VoterTrace - Optimized OCR</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
/* CSS Reset & Base */
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
body{font-family:'Inter',system-ui,sans-serif;background:#f0f4f8;color:#0f172a;min-height:100vh;font-size:15px;line-height:1.55}

/* Nav */
.topbar{position:sticky;top:0;z-index:50;background:#1e293b;display:flex;align-items:center;padding:0 24px;height:56px;gap:8px;box-shadow:0 1px 8px rgba(0,0,0,.25)}
.topbar-logo{font-weight:800;font-size:17px;color:#fff;margin-right:16px;letter-spacing:-.3px}
.tab-btn{padding:7px 18px;border-radius:8px;border:none;background:none;font-size:13px;font-weight:600;color:#94a3b8;cursor:pointer;transition:all .15s}
.tab-btn:hover{background:rgba(255,255,255,.1);color:#fff}
.tab-btn.on{background:#2563eb;color:#fff}

/* Layout */
.page{display:none;max-width:800px;margin:0 auto;padding:32px 20px 100px}
.page.on{display:block}
.page-title{font-size:24px;font-weight:800;margin-bottom:6px;letter-spacing:-.3px}
.page-sub{font-size:14px;color:#64748b;margin-bottom:28px}

/* Card */
.box{background:#fff;border:1px solid #e2e8f0;border-radius:16px;padding:24px;margin-bottom:16px;box-shadow:0 1px 4px rgba(0,0,0,.04)}
.box-head{font-size:11px;font-weight:700;text-transform:uppercase;letter-spacing:.8px;color:#94a3b8;margin-bottom:18px}

/* Upload */
.upload-grid{display:grid;grid-template-columns:1fr 1fr;gap:14px}
@media(max-width:520px){.upload-grid{grid-template-columns:1fr}}
.slot-label{font-size:12px;font-weight:700;margin-bottom:8px;display:block}
.slot-label.f{color:#2563eb}
.upload-btn{display:flex;flex-direction:column;align-items:center;justify-content:center;gap:8px;width:100%;min-height:140px;border:2px dashed #cbd5e1;border-radius:12px;background:#f8fafc;cursor:pointer;transition:all .18s}
.upload-btn:hover{border-color:#2563eb;background:#eff6ff}
.upload-btn.selected{border-color:#16a34a;background:#f0fdf4;color:#15803d}
.thumb{width:100%;max-height:150px;object-fit:contain;border-radius:8px;margin-top:10px;display:none;background: #eee}

/* Fields */
.field-grid{display:grid;grid-template-columns:1fr 1fr;gap:10px}
@media(max-width:480px){.field-grid{grid-template-columns:1fr}}
.field-item{background:#f8fafc;border-radius:10px;padding:13px 15px;position:relative;border: 1px solid #f1f5f9}
.field-k{font-size:10px;font-weight:700;color:#94a3b8;text-transform:uppercase;margin-bottom:4px}
.field-v{font-size:15px;font-weight:600;color:#0f172a}
.copy-btn{position:absolute;top:10px;right:10px;background:white;border:1px solid #e2e8f0;border-radius:5px;padding:2px 8px;font-size:10px;cursor:pointer;opacity:0.6}
.copy-btn:hover{opacity:1; background:#2563eb; color:white}

/* Progress */
.prog-wrap{margin-top:15px;display:none}.prog-wrap.on{display:block}
.prog-track{height:8px;background:#e2e8f0;border-radius:4px;overflow:hidden}
.prog-bar{height:100%;background:#2563eb;width:0%;transition:width .3s}

.btn{width:100%;padding:14px;border-radius:10px;border:none;background:#2563eb;color:#fff;font-weight:700;cursor:pointer;margin-top:15px}
.btn:disabled{background:#cbd5e1;cursor:not-allowed}
</style>
</head>
<body>

<div class="topbar">
  <span class="topbar-logo">VoterTrace</span>
  <button class="tab-btn on" id="t1" onclick="go('voter-id','t1')">Voter ID Reader</button>
</div>

<div class="page on" id="voter-id">
  <p class="page-title">Voter ID Reader</p>
  <p class="page-sub">Upload your card to extract details. (Optimized for Name Detection)</p>

  <div class="box">
    <div class="box-head">Upload Card Images</div>
    <div class="upload-grid">
      <div>
        <span class="slot-label f">‚ñ≤ Front side</span>
        <button class="upload-btn" id="front-btn" onclick="document.getElementById('fi-front').click()">
          <span style="font-size:32px">ü™™</span>
          <span id="front-lbl">Upload Front</span>
        </button>
        <input type="file" id="fi-front" accept="image/*" style="display:none">
        <img id="front-thumb" class="thumb">
      </div>
      <div>
        <span class="slot-label" style="color:#7c3aed">‚ñº Back side (Optional)</span>
        <button class="upload-btn" id="back-btn" onclick="document.getElementById('fi-back').click()">
          <span style="font-size:32px">üè†</span>
          <span id="back-lbl">Upload Back</span>
        </button>
        <input type="file" id="fi-back" accept="image/*" style="display:none">
        <img id="back-thumb" class="thumb">
      </div>
    </div>

    <div class="prog-wrap" id="id-prog">
      <div class="prog-track"><div class="prog-bar" id="id-bar"></div></div>
      <p id="id-txt" style="font-size:12px; margin-top:5px; color:#64748b">Initializing...</p>
    </div>

    <button class="btn" id="id-btn" onclick="scanId()">Scan Voter ID</button>
  </div>

  <div id="id-out" style="display:none">
    <div class="box">
      <div class="box-head">Extracted Details</div>
      <div class="field-grid" id="id-fields"></div>
      <details style="margin-top:15px">
        <summary style="font-size:12px; color:#94a3b8; cursor:pointer">View Raw Text</summary>
        <pre id="id-raw" style="font-size:10px; background:#f8fafc; padding:10px; margin-top:5px; white-space:pre-wrap"></pre>
      </details>
    </div>
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/tesseract.js/5.0.4/tesseract.min.js"></script>
<script>
const G = { frontFile:null, backFile:null };

// Navigation
function go(p, t) {
  document.querySelectorAll('.page').forEach(el=>el.classList.remove('on'));
  document.getElementById(p).classList.add('on');
}

// File Handlers
document.getElementById('fi-front').onchange = e => handleFile(e, 'front');
document.getElementById('fi-back').onchange = e => handleFile(e, 'back');

function handleFile(e, type) {
  const file = e.target.files[0];
  if(!file) return;
  G[type+'File'] = file;
  document.getElementById(type+'-btn').classList.add('selected');
  document.getElementById(type+'-lbl').textContent = file.name;
  const reader = new FileReader();
  reader.onload = ev => {
    const img = document.getElementById(type+'-thumb');
    img.src = ev.target.result;
    img.style.display = 'block';
  }
  reader.readAsDataURL(file);
}

async function scanId() {
  if(!G.frontFile) return alert("Upload front image!");
  
  const btn = document.getElementById('id-btn');
  const prog = document.getElementById('id-prog');
  btn.disabled = true;
  prog.classList.add('on');

  try {
    const worker = await Tesseract.createWorker(['eng', 'kan']);
    
    setPb(20, "Reading Front Side...");
    const { data: { text: frontText } } = await worker.recognize(G.frontFile);
    
    let backText = "";
    if(G.backFile) {
      setPb(60, "Reading Back Side...");
      const { data: { text: bTxt } } = await worker.recognize(G.backFile);
      backText = bTxt;
    }

    await worker.terminate();
    
    setPb(90, "Processing Details...");
    const result = extractId(frontText, backText);
    renderResults(result, frontText + "\n" + backText);
    setPb(100, "Done!");

  } catch (err) {
    console.error(err);
    alert("Scan failed. Try a clearer photo.");
  } finally {
    btn.disabled = false;
  }
}

function setPb(pct, msg) {
  document.getElementById('id-bar').style.width = pct + "%";
  document.getElementById('id-txt').textContent = msg;
}

// ‚îÄ‚îÄ OPTIMIZED EXTRACTION ENGINE ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ

function extractId(front, back) {
  const f = { electorName:'', electorNameKan:'', fatherName:'', fatherNameKan:'', sex:'', epicNo:'', addr:'' };
  const allText = front + "\n" + back;

  // 1. EPIC Number (Improved)
  const epicM = allText.match(/\b([A-Z]{3}[0-9IO]{7,8})\b/i);
  if(epicM) f.epicNo = epicM[1].toUpperCase().replace(/O/g, '0').replace(/I/g, '1');

  // 2. English Elector Name (Fuzzy Label + Positional Fallback)
  f.electorName = matchEngField(front, [/elector[''s\s]*name/i, /voter[''s\s]*name/i, /name\s*of\s*elector/i]);
  if(!f.electorName) f.electorName = scanForName(front, f.epicNo);

  // 3. Father/Husband Name
  f.fatherName = matchEngField(front, [/father[''s\s]*name/i, /husband[''s\s]*name/i, /relation/i]);
  if(!f.fatherName) f.fatherName = scanForName(front, f.epicNo, f.electorName);

  // 4. Sex
  const sexM = front.match(/\b(sex|gender)\s*[:\-]?\s*(male|female|m\b|f\b)/i);
  if(sexM) f.sex = (sexM[2].toLowerCase().startsWith('m')) ? 'Male' : 'Female';

  // 5. Kannada Fields (With Token-Filtering to strip Latin noise)
  f.electorNameKan = kanField(front, [/‡≤Æ‡≤§‡≤¶‡≤æ‡≤∞‡≤∞\s*‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å/, /‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å/]);
  f.fatherNameKan = kanField(front, [/‡≤§‡≤Ç‡≤¶‡≥Ü‡≤Ø\s*‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å/, /‡≤™‡≤§‡≤ø‡≤Ø\s*‡≤π‡≥Ü‡≤∏‡≤∞‡≥Å/, /‡≤∏‡≤Ç‡≤¨‡≤Ç‡≤ß‡≤ø/]);

  // 6. Address (Simple back-side scan)
  if(back) {
    const addrM = back.match(/address\s*[:\-]\s*([\s\S]{5,150})/i);
    if(addrM) f.addr = cleanText(addrM[1].split('\n\n')[0]);
  }

  return f;
}

function scanForName(text, epicNo, alreadyFound) {
  const lines = text.split('\n').map(l=>l.trim()).filter(l => l.length > 3);
  const ignore = /election|commission|india|government|voter|elector|father|husband|sex|address|identity|card|photo/i;
  
  for(const ln of lines) {
    if(epicNo && ln.includes(epicNo)) continue;
    if(ignore.test(ln)) continue;
    if(alreadyFound && ln.toLowerCase().includes(alreadyFound.toLowerCase())) continue;
    
    // Pattern: 2-4 Capitalized words
    if(/^[A-Z\s\.]{3,40}$/i.test(ln) && ln.split(' ').length >= 2) return cleanText(ln);
  }
  return '';
}

function kanField(text, patterns) {
  const lines = text.split('\n').map(l=>l.trim());
  for(const re of patterns) {
    for(let i=0; i<lines.length; i++) {
      if(re.test(lines[i])) {
        let val = lines[i].replace(re, '').replace(/^[:\s\-|‚Äì]+/, '').trim();
        if(!val && lines[i+1]) val = lines[i+1].trim();
        if(val) {
          // Keep only tokens containing Kannada characters (removes "5 Ae", "Male", etc)
          const filtered = val.split(/\s+/).filter(tok => /[\u0C80-\u0CFF]/.test(tok));
          return filtered.join(' ');
        }
      }
    }
  }
  return '';
}

function matchEngField(text, patterns) {
  const lines = text.split('\n').map(l=>l.trim());
  for(const re of patterns) {
    for(let i=0; i<lines.length; i++) {
      if(re.test(lines[i])) {
        let val = lines[i].replace(re, '').replace(/^[:\s\-|‚Äì]+/, '').trim();
        if(!val && lines[i+1]) val = lines[i+1].trim();
        if(val && val.length > 2 && !/name|elector/i.test(val)) return cleanText(val);
      }
    }
  }
  return '';
}

function cleanText(s) { return s.replace(/\s+/g, ' ').trim(); }

function renderResults(f, raw) {
  const fields = [
    {k: "Elector Name", v: f.electorName},
    {k: "Name (Kannada)", v: f.electorNameKan},
    {k: "Father Name", v: f.fatherName},
    {k: "Father Name (Kan)", v: f.fatherNameKan},
    {k: "Sex", v: f.sex},
    {k: "EPIC No", v: f.epicNo},
    {k: "Address", v: f.addr}
  ];

  document.getElementById('id-fields').innerHTML = fields.map(field => `
    <div class="field-item">
      <div class="field-k">${field.k}</div>
      <div class="field-v">${field.v || '---'}</div>
      ${field.v ? `<button class="copy-btn" onclick="copyText('${field.v.replace(/'/g, "\\'")}')">Copy</button>` : ''}
    </div>
  `).join('');
  
  document.getElementById('id-raw').textContent = raw;
  document.getElementById('id-out').style.display = 'block';
}

function copyText(txt) {
  navigator.clipboard.writeText(txt);
  alert("Copied: " + txt);
}
</script>
</body>
</html>
